
# HACK IT AWAY

At the moment there is an issue with the composer that prevents the full workflow to work correctly.  
You can try a scaled down version of it based on RHEL 8.7+.

Start by installing RHEL 8.7+ on the **Management System** and run the setup image builder [script](scripts/configure-builder).

Configure local Microshift repo with the following [script](scripts/mirror-repos).  

For the building process you can use the 2 blueprints provided in the [blueprint](blueprints/) folder:  
- the [blueprint](blueprints/blueprint_first_step.toml) needs to be pushed and built as the first one and it includes Microshift and other troubleshooting packages  
- the [blueprint](blueprints/blueprint_second_step.toml) will produce an ISO, usable on **Edge Device**. Make sure to change the `<DISK_DEVICE>` with the disk you are installing to ([VDA](blueprints/blueprint_second_step.toml#L9) in the case of VM).  

To perform the first build you can run:

`sudo composer-cli compose start-ostree <BLUEPRINT_NAME> edge-container`

Download the generated container (TAR file): 

`sudo composer-cli compose image <uuid>`

Change the owner with:  

`sudo chown $(whoami) <IMAGE_TAR_FILE>`  

Load and run the container with Podman:  

`sudo podman load -i UUID-container.tar`

Tag the new RHEL for Edge Container image, using the image ID generated by the previous step:  

`sudo podman tag image-ID localhost/edge-container`

Run the container named edge-container and expose it on port 8080 (make sure the firewall is open on that port on the *Image Builder*):  

`sudo podman run -d --name=edge-container -p 8090:8080 localhost/edge-container`

Build the final installer image with:  

`sudo composer-cli compose start-ostree <BLUEPRINT_INSTALLER_NAME> edge-simplified-installer --ref rhel/${baserelease}/${basearch}/edge --url http://<IMAGE_BUILDER_IP>:<IMAGE_PUBLISH_PORT>/repo/`

Find the ID of the generate image with:  

`sudo watch composer-cli compose status`

Then, download the ISO file from the Image Builder using the ID and change the owner if you are not using the root user:
```
sudo composer-cli compose image <ISO_IMAGE_ID>
sudo chown $(whoami) <FDO_ISO_IMAGE_ID>-simplified-installer.iso
```

At this point you should have an ISO file (downloaded in the Image Builder) that you can use to deploy the **Edge Device**.  

To add your Username and other variables at installation time, run the kickstart [script](kickstarts/embed-ks) for preparing and embedding a kickstart in the ISO you just generated.  

The scripts expects the download ISO to be called `installer-0.0.0-installer.iso` and make sure to change in the script the location of the published repo to yours `http://<IMAGE_BUILDER_IP>:<IMAGE_PUBLISH_PORT>` and have the `pull-secret` in $HOME. You can download your installation pull secret from the [Red Hat Hybrid Cloud Console](https://console.redhat.com/). This pull secret allows you to authenticate with the Red Hat container registries that serve the container images used by Red Hat build of MicroShift.  
Run the script like this:  
` ./embed-ks`

You should now have an ISO enriched with the Kickstart file (following this [structure](kickstarts/kickstart.ks.tmpl)).  